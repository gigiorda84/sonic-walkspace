'use client';

import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';

const IS_CLIENT = typeof window !== 'undefined';
const hasOPFS = IS_CLIENT && (navigator as any)?.storage?.getDirectory;

// Subtitle Functions
interface SubtitleEntry {
  id: number;
  startTime: string;
  endTime: string;
  text: string;
  startSeconds: number;
  endSeconds: number;
}

function parseSRT(srtContent: string): SubtitleEntry[] {
  if (!srtContent) return [];
  
  const entries: SubtitleEntry[] = [];
  const blocks = srtContent.trim().split('\n\n');
  
  blocks.forEach(block => {
    const lines = block.trim().split('\n');
    if (lines.length >= 3) {
      const id = parseInt(lines[0]);
      const timecode = lines[1];
      const text = lines.slice(2).join('\n');
      
      const [startTime, endTime] = timecode.split(' --> ');
      if (startTime && endTime) {
        entries.push({
          id,
          startTime: startTime.trim(),
          endTime: endTime.trim(),
          text,
          startSeconds: timeToSeconds(startTime.trim()),
          endSeconds: timeToSeconds(endTime.trim())
        });
      }
    }
  });
  
  return entries;
}

function timeToSeconds(timeStr: string): number {
  const [time, ms] = timeStr.split(',');
  const [hours, minutes, seconds] = time.split(':').map(Number);
  return hours * 3600 + minutes * 60 + seconds + (ms ? parseInt(ms) / 1000 : 0);
}

function getCurrentSubtitle(subtitles: SubtitleEntry[], currentTime: number): SubtitleEntry | null {
  const currentSub = subtitles.find(sub => {
    return currentTime >= sub.startSeconds && currentTime <= sub.endSeconds;
  });
  
  return currentSub || null;
}

// Layer switcher component
function LayerSwitcher({ currentLayer, onLayerChange, layers }: {
  currentLayer: string;
  onLayerChange: (layer: string) => void;
  layers: Record<string, { name: string; url: string; attribution: string }>;
}) {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="absolute top-4 right-4 z-[1000]">
      <div className="relative">
        <button
          onClick={() => setIsOpen(!isOpen)}
          className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all duration-200 shadow-lg flex items-center gap-2"
        >
          <span>üó∫Ô∏è</span>
          {layers[currentLayer]?.name || 'Map'}
          <span className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
        </button>
        
        {isOpen && (
          <div className="absolute top-full right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-xl overflow-hidden min-w-[120px]">
            {Object.entries(layers).map(([key, layer]) => (
              <button
                key={key}
                onClick={() => {
                  onLayerChange(key);
                  setIsOpen(false);
                }}
                className={`w-full px-4 py-2 text-left text-sm hover:bg-gray-100 transition-colors duration-200 ${
                  currentLayer === key ? 'bg-indigo-50 text-indigo-700 font-medium' : 'text-gray-700'
                }`}
              >
                {layer.name}
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// Map component for the player
function PlayerMap({ tour, userPos, activeRegionId, jumpToRegion, setUserPos, openModal }: {
  tour: any;
  userPos: { lat: number; lng: number } | null;
  activeRegionId: string | null;
  jumpToRegion: (id: string) => void;
  setUserPos: (pos: { lat: number; lng: number }) => void;
  openModal?: (region: any) => void;
}) {
  const [isMapReady, setIsMapReady] = useState(false);
  const [MapContainer, setMapContainer] = useState<any>(null);
  const [TileLayer, setTileLayer] = useState<any>(null);
  const [Circle, setCircle] = useState<any>(null);
  const [Polyline, setPolyline] = useState<any>(null);
  const [useMapEvents, setUseMapEvents] = useState<any>(null);
  const [currentLayer, setCurrentLayer] = useState('dark');

  // Define available map layers
  const mapLayers = {
    streets: {
      name: 'Streets',
      url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    },
    satellite: {
      name: 'Satellite',
      url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    },
    terrain: {
      name: 'Terrain',
      url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="https://opentopomap.org/">OpenTopoMap</a>'
    },
    dark: {
      name: 'Dark',
      url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }
  };

  useEffect(() => {
    if (!IS_CLIENT) return;
    
    // Load Leaflet CSS
    const id = "leaflet-css-cdn";
    if (!document.getElementById(id)) {
      const link = document.createElement("link");
      link.id = id;
      link.rel = "stylesheet";
      link.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
      link.integrity = "sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=";
      link.crossOrigin = "";
      document.head.appendChild(link);
    }

    // Load all components dynamically
    Promise.all([
      import("leaflet"),
      import("react-leaflet").then(mod => mod.MapContainer),
      import("react-leaflet").then(mod => mod.TileLayer),
      import("react-leaflet").then(mod => mod.Circle),
      import("react-leaflet").then(mod => mod.Polyline),
      import("react-leaflet").then(mod => mod.useMapEvents)
    ]).then(([leaflet, MapContainerComp, TileLayerComp, CircleComp, PolylineComp, useMapEventsHook]) => {
      const L = leaflet.default;
      const iconUrl = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png";
      const iconRetinaUrl = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png";
      const shadowUrl = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png";
      // @ts-ignore
      delete L.Icon.Default.prototype._getIconUrl;
      L.Icon.Default.mergeOptions({ iconUrl, iconRetinaUrl, shadowUrl });
      
      setMapContainer(() => MapContainerComp);
      setTileLayer(() => TileLayerComp);
      setCircle(() => CircleComp);
      setPolyline(() => PolylineComp);
      setUseMapEvents(() => useMapEventsHook);
      setIsMapReady(true);
    });
  }, []);

  if (!isMapReady || !MapContainer) {
    return (
      <div className="h-[520px] w-full flex items-center justify-center bg-gradient-to-br from-neutral-900 to-neutral-800 rounded-2xl border border-neutral-800">
        <div className="flex flex-col items-center gap-3">
          <div className="h-8 w-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 animate-spin" />
          <div className="text-sm text-neutral-400">Loading interactive map...</div>
        </div>
      </div>
    );
  }

  return (
    <div className="rounded-2xl border border-neutral-800/50 overflow-hidden shadow-2xl relative">
              <LayerSwitcher
          currentLayer={currentLayer}
          onLayerChange={(layer) => {
            console.log('Player: Switching to layer:', layer);
            setCurrentLayer(layer);
          }}
          layers={mapLayers}
        />
      <MapContainer 
        center={[(tour.regions[0]?.center.lat || 45.07), (tour.regions[0]?.center.lng || 7.68)]} 
        zoom={14} 
        style={{ height: 520, width: '100%' }} 
        scrollWheelZoom
        className="rounded-2xl"
      >
        <TileLayer 
          attribution={mapLayers[currentLayer].attribution}
          url={mapLayers[currentLayer].url}
          key={currentLayer} // Force re-render when layer changes
        />
        <Polyline positions={(tour.regions || []).map((r: any) => [r.center.lat, r.center.lng])} pathOptions={{ color: '#8b5cf6', weight: 3, opacity: 0.8 }} />
        {(tour.regions || []).map((r: any) => (
          <Circle 
            key={r.id} 
            center={[r.center.lat, r.center.lng]} 
            radius={r.radiusM} 
            pathOptions={{ 
              color: r.id === activeRegionId ? '#10b981' : '#8b5cf6', 
              fillColor: r.id === activeRegionId ? '#10b981' : '#8b5cf6', 
              fillOpacity: r.id === activeRegionId ? 0.2 : 0.1, 
              weight: r.id === activeRegionId ? 3 : 2 
            }} 
            eventHandlers={{ click: () => openModal ? openModal(r) : jumpToRegion(r.id) }} 
          />
        ))}
        {userPos && (
          <Circle 
            center={[userPos.lat, userPos.lng]} 
            radius={8} 
            pathOptions={{ color: '#f59e0b', fillColor: '#f59e0b', fillOpacity: 0.8, weight: 2 }} 
          />
        )}
        {useMapEvents && <ClickToSimulate on={(ll) => setUserPos(ll)} useMapEvents={useMapEvents} />}
      </MapContainer>
    </div>
  );
}

// Click handler component
function ClickToSimulate({ on, useMapEvents }: { on: (p: { lat: number; lng: number }) => void, useMapEvents: any }) {
  const map = useMapEvents({
    click(e: any) {
      on({ lat: e.latlng.lat, lng: e.latlng.lng });
    }
  });

  return null; // useMapEvents doesn't return a component, it returns the map instance
}

const DEMO_TOUR = { 
  slug:'bandite-demo', 
  title:'Sonic Walkscape ‚Äî Player', 
  locales:['it-IT','fr-FR'], 
  defaultLocale:'it-IT', 
  regions:[ 
    { id:'reg-1', name:{'it-IT':'Porta Palazzo','fr-FR':'Porta Palazzo'}, center:{ lat:45.0749,lng:7.6774 }, radiusM:120, sort:1, track:{'it-IT':{ kind:'tone', frequency:440 }, 'fr-FR':{ kind:'tone', frequency:442}} }, 
    { id:'reg-2', name:{'it-IT':'Piazza Castello','fr-FR':'Piazza Castello'}, center:{ lat:45.0705,lng:7.6868 }, radiusM:120, sort:2, track:{'it-IT':{ kind:'tone', frequency:494 }, 'fr-FR':{ kind:'tone', frequency:496}} }, 
    { id:'reg-3', name:{'it-IT':'Parco del Valentino','fr-FR':'Parc du Valentino'}, center:{ lat:45.0567,lng:7.6861 }, radiusM:140, sort:3, track:{'it-IT':{ kind:'tone', frequency:523 }, 'fr-FR':{ kind:'tone', frequency:525}} } 
  ] 
};

function getPreviewTour() {
  try { const raw = localStorage.getItem('WS_PREVIEW_MANIFEST'); if (!raw) return null; return JSON.parse(raw); } catch { return null; }
}

function getCMSTours() {
  try { 
    const raw = localStorage.getItem('WS_CMS_TOURS'); 
    if (!raw) return null; 
    const parsed = JSON.parse(raw);
    
    // Validate that we have a valid array of tours
    if (!Array.isArray(parsed)) {
      console.warn('WS_CMS_TOURS is not an array:', parsed);
      return null;
    }
    
    // Filter only published tours
    const publishedTours = parsed.filter(tour => 
      tour && 
      typeof tour === 'object' && 
      tour.slug && 
      tour.title && 
      Array.isArray(tour.regions) &&
      tour.published === true // Only published tours
    );
    
    if (publishedTours.length !== parsed.length) {
      console.log(`Filtered ${parsed.length - publishedTours.length} unpublished tours`);
    }
    
    return publishedTours.length > 0 ? publishedTours : null;
  } catch (error) { 
    console.error('Error reading CMS tours from localStorage:', error);
    return null; 
  }
}

function saveCMSTours(tours: any[]) {
  try {
    localStorage.setItem('WS_CMS_TOURS', JSON.stringify(tours));
  } catch (err) {
    console.error('Failed to save tours to localStorage:', err);
  }
}

export default function SonicWalkscapeWebPlayer(){
  const preview = IS_CLIENT ? getPreviewTour() : null;
  const cmsTours = IS_CLIENT ? getCMSTours() : null;
  
  // Audio context and state
  const [audioContext, setAudioContext] = useState<AudioContext | null>(null);
  const [currentAudio, setCurrentAudio] = useState<HTMLAudioElement | null>(null);
  const [isPlaying, setIsPlaying] = useState(false);
  
  // Subtitle state
  const [currentSubtitle, setCurrentSubtitle] = useState<SubtitleEntry | null>(null);
  const [subtitles, setSubtitles] = useState<SubtitleEntry[]>([]);
  
  // Modal state
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalRegion, setModalRegion] = useState<any>(null);
  const [currentRegionIndex, setCurrentRegionIndex] = useState(0);
  const [isInfoModalOpen, setIsInfoModalOpen] = useState(false);
  
  // Convert CMS tour format to player format
  const convertCMSTourToPlayer = (cmsTour: any) => {
    // Validate tour structure
    if (!cmsTour || typeof cmsTour !== 'object') {
      console.warn('Invalid CMS tour structure:', cmsTour);
      return null;
    }
    
    if (!cmsTour.slug || !cmsTour.title || !Array.isArray(cmsTour.regions)) {
      console.warn('CMS tour missing required properties:', cmsTour);
      return null;
    }

    try {
      // Get the language for this tour
      const tourLocale = cmsTour.locale || cmsTour.locales?.[0]?.code || 'it-IT';
      
      return {
        slug: cmsTour.slug,
        title: cmsTour.title,
        description: cmsTour.description || '',
        tourImageDataUrl: cmsTour.tourImageDataUrl || '',
        locale: tourLocale,
        parentTourId: cmsTour.parentTourId,
        regions: cmsTour.regions.map((r: any) => ({
          id: r.id || `region-${Math.random()}`,
          name: cmsTour.tracks?.[tourLocale]?.[r.id]?.title || `Punto ${r.sort || 1}`,
          description: cmsTour.tracks?.[tourLocale]?.[r.id]?.description || '',
          transcript: cmsTour.tracks?.[tourLocale]?.[r.id]?.transcript || '',
          imageDataUrl: cmsTour.tracks?.[tourLocale]?.[r.id]?.imageDataUrl || '',
          center: { lat: r.lat || 45.07, lng: r.lng || 7.68 },
          radiusM: r.radiusM || 120,
          sort: r.sort || 1,
          track: cmsTour.tracks?.[tourLocale]?.[r.id] || { kind: 'tone', frequency: 440 }
        })),
        availableLanguages: [] // Will be populated later
      } as any;
    } catch (error) {
      console.error('Error converting CMS tour to player format:', error, cmsTour);
      return null;
    }
  };

  const availableTours = useMemo(() => {
    const tours = [];
    
    if (cmsTours && cmsTours.length > 0) {
      // Group tours by parent tour ID to show language variants
      const tourGroups = new Map();
      
      cmsTours.forEach((cmsTour: any) => {
        const parentId = cmsTour.parentTourId || cmsTour.id;
        if (!tourGroups.has(parentId)) {
          tourGroups.set(parentId, []);
        }
        tourGroups.get(parentId).push(cmsTour);
      });
      
      // Convert each group to a single tour with language options
      tourGroups.forEach((groupTours: any[]) => {
        const mainTour = groupTours[0];
        const convertedTour = convertCMSTourToPlayer(mainTour);
        if (convertedTour) {
          // Add available languages
          convertedTour.availableLanguages = groupTours.map((t: any) => ({
            code: t.locale || t.locales?.[0]?.code || 'it-IT',
            title: t.title,
            tourId: t.id
          }));
          tours.push(convertedTour);
        }
      });
    }
    
    if (preview) {
      tours.push(preview);
    }
    
    if (tours.length === 0) {
      tours.push(DEMO_TOUR);
    }
    
    return tours;
  }, [cmsTours, preview]);

  const [selectedTourIndex, setSelectedTourIndex] = useState(0);
  const [locale, setLocale] = useState(availableTours[0]?.locale || 'it-IT');
  const [usingGPS, setUsingGPS] = useState(false);
  const [userPos, setUserPos] = useState<{lat:number,lng:number}|null>(null);
  const [activeRegionId, setActiveRegionId] = useState<string|null>(null);

  const TOUR = availableTours[selectedTourIndex] || DEMO_TOUR;

  // Update locale when tour changes
  useEffect(() => {
    setLocale(TOUR.locale || TOUR.defaultLocale || 'it-IT');
  }, [TOUR.locale, TOUR.defaultLocale]);

  const center = useMemo(()=> userPos ?? (TOUR.regions[0]?.center || {lat:45.07,lng:7.68}), [userPos, TOUR]);

  useEffect(()=>{ 
    if(!usingGPS) return; 
    const id = navigator.geolocation.watchPosition( 
      (pos)=> {
        const newPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        setUserPos(newPos);
        
        // Check if user entered a region
        const enteredRegion = (TOUR.regions || []).find((r: any) => {
          const distance = Math.sqrt(
            Math.pow(newPos.lat - r.center.lat, 2) + 
            Math.pow(newPos.lng - r.center.lng, 2)
          ) * 111000; // Convert to meters (roughly)
          return distance <= r.radiusM;
        });
        
        if (enteredRegion && enteredRegion.id !== activeRegionId) {
          // Stop current audio if playing
          stopAudio();
          
          setActiveRegionId(enteredRegion.id);
          
          // Play audio for the region
          const track = enteredRegion.track;
          if (track) {
            if (track.kind === 'tone' && track.frequency) {
              playTone(track.frequency);
            } else if (track.audioDataUrl) {
              playAudio(track.audioDataUrl);
            } else {
              // Try to find audio data in CMS tracks
              const cmsTour = findCMSTour();
              if (cmsTour) {
                const cmsTrack = cmsTour.tracks?.[locale]?.[enteredRegion.id];
                if (cmsTrack?.audioDataUrl) {
                  // Get subtitle content if available
                  const subtitleContent = cmsTour.subtitles?.[locale]?.[cmsTrack.subtitleId]?.content || '';
                  playAudio(cmsTrack.audioDataUrl, subtitleContent);
                }
              }
            }
          }
        }
      }, 
      ()=>{}, 
      { enableHighAccuracy:true, timeout:10000, maximumAge:1000 } 
    ); 
    return ()=> navigator.geolocation.clearWatch(id); 
  }, [usingGPS, TOUR, locale, activeRegionId, cmsTours]);

  // Initialize audio context
  useEffect(() => {
    if (IS_CLIENT && !audioContext) {
      const ctx = new (window.AudioContext || (window as any).webkitAudioContext)();
      setAudioContext(ctx);
    }
  }, [audioContext]);

  // Function to play tone
  const playTone = (frequency: number, duration: number = 2000) => {
    if (!audioContext) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.1);
    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  };

  // Function to play audio file
  const playAudio = (audioDataUrl: string, srtContent?: string) => {
    if (!audioDataUrl) return;
    
    // Stop current audio if playing
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
    }
    
    // Parse subtitles if provided
    let parsedSubtitles: SubtitleEntry[] = [];
    if (srtContent) {
      parsedSubtitles = parseSRT(srtContent);
      setSubtitles(parsedSubtitles);
    } else {
      setSubtitles([]);
    }
    setCurrentSubtitle(null);
    
    const audio = new Audio(audioDataUrl);
    audio.volume = 1.0;
    
    audio.onplay = () => setIsPlaying(true);
    audio.onpause = () => setIsPlaying(false);
    audio.onended = () => {
      setIsPlaying(false);
      setCurrentSubtitle(null);
    };
    audio.onerror = (e) => {
      console.error('Audio playback error:', e);
      setIsPlaying(false);
    };
    
    audio.ontimeupdate = () => {
      if (parsedSubtitles.length > 0) {
        const current = getCurrentSubtitle(parsedSubtitles, audio.currentTime);
        setCurrentSubtitle(current);
      }
    };
    
    setCurrentAudio(audio);
    audio.play().catch(err => {
      console.error('Failed to play audio:', err);
      setIsPlaying(false);
    });
  };

  // Function to stop current audio
  const stopAudio = () => {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      setCurrentAudio(null);
      setIsPlaying(false);
    }
    setCurrentSubtitle(null);
    setSubtitles([]);
  };

  // Modal functions
  const openModal = (region: any) => {
    const regionIndex = (TOUR.regions || []).findIndex((r: any) => r.id === region.id);
    setCurrentRegionIndex(regionIndex);
    setModalRegion(region);
    setIsModalOpen(true);
    
    // Auto-start audio when opening modal
    const track = region.track;
    if (track) {
      if (track.kind === 'tone' && track.frequency) {
        playTone(track.frequency);
      } else if (track.audioDataUrl) {
        playAudio(track.audioDataUrl);
      } else {
        // Try to find audio data in CMS tracks
        const cmsTour = findCMSTour();
        if (cmsTour) {
          const locale = TOUR.locale || 'it-IT';
          const cmsTrack = cmsTour.tracks?.[locale]?.[region.id];
          if (cmsTrack?.audioDataUrl) {
            // Get subtitle content if available
            const subtitleContent = cmsTour.subtitles?.[locale]?.[cmsTrack.subtitleId]?.content || '';
            playAudio(cmsTrack.audioDataUrl, subtitleContent);
          }
        }
      }
    }
  };

  const closeModal = () => {
    setIsModalOpen(false);
    setModalRegion(null);
  };

  const navigateModal = (direction: 'prev' | 'next') => {
    const regions = TOUR.regions || [];
    let newIndex = currentRegionIndex;
    
    if (direction === 'prev') {
      newIndex = currentRegionIndex > 0 ? currentRegionIndex - 1 : regions.length - 1;
    } else {
      newIndex = currentRegionIndex < regions.length - 1 ? currentRegionIndex + 1 : 0;
    }
    
    // Stop current audio
    stopAudio();
    
    const newRegion = regions[newIndex];
    setCurrentRegionIndex(newIndex);
    setModalRegion(newRegion);
    
    // Start new audio after a short delay
    setTimeout(() => {
      const track = newRegion.track;
      if (track) {
        if (track.kind === 'tone' && track.frequency) {
          playTone(track.frequency);
        } else if (track.audioDataUrl) {
          playAudio(track.audioDataUrl);
        } else {
          // Try to find audio data in CMS tracks
          const cmsTour = findCMSTour();
          if (cmsTour) {
            const locale = TOUR.locale || 'it-IT';
            const cmsTrack = cmsTour.tracks?.[locale]?.[newRegion.id];
            if (cmsTrack?.audioDataUrl) {
              // Get subtitle content if available
              const subtitleContent = cmsTour.subtitles?.[locale]?.[cmsTrack.subtitleId]?.content || '';
              playAudio(cmsTrack.audioDataUrl, subtitleContent);
            }
          }
        }
      }
    }, 100);
  };

  // Info modal functions
  const openInfoModal = () => {
    setIsInfoModalOpen(true);
  };

  const closeInfoModal = () => {
    setIsInfoModalOpen(false);
  };

  // Start tour function
  const startTour = () => {
    const firstRegion = (TOUR.regions || [])[0];
    if (firstRegion) {
      openModal(firstRegion);
    }
  };

  const jumpToRegion = (id:string)=> { 
    const r = (TOUR.regions||[]).find((x:any)=> x.id===id); 
    if(r){ 
      // Stop current audio if playing
      stopAudio();
      
      setUserPos(r.center); 
      setUsingGPS(false); 
      setActiveRegionId(r.id);
      
      // Play audio for the region
      const track = r.track;
      if (track) {
        if (track.kind === 'tone' && track.frequency) {
          playTone(track.frequency);
        } else if (track.audioDataUrl) {
          playAudio(track.audioDataUrl);
        } else {
          // Try to find audio data in CMS tracks
          const cmsTour = findCMSTour();
          if (cmsTour) {
            const cmsTrack = cmsTour.tracks?.[locale]?.[r.id];
            if (cmsTrack?.audioDataUrl) {
              // Get subtitle content if available
              const subtitleContent = cmsTour.subtitles?.[locale]?.[cmsTrack.subtitleId]?.content || '';
              playAudio(cmsTrack.audioDataUrl, subtitleContent);
            }
          }
        }
      }
    }
  };
  
  // Helper function to find the correct CMS tour
  const findCMSTour = () => {
    if (!cmsTours) return null;
    
    // First try to find by slug
    let cmsTour = cmsTours.find(t => t.slug === TOUR.slug);
    
    // If not found, try to find by available languages
    if (!cmsTour && TOUR.availableLanguages) {
      for (const lang of TOUR.availableLanguages) {
        cmsTour = cmsTours.find(t => t.id === lang.tourId);
        if (cmsTour) break;
      }
    }
    
    // If still not found, try to find by parent tour ID
    if (!cmsTour && TOUR.parentTourId) {
      cmsTour = cmsTours.find(t => t.id === TOUR.parentTourId);
    }
    
    return cmsTour;
  };

  // Keyboard navigation for modal
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      if (!isModalOpen) return;
      
      if (e.key === 'Escape') {
        closeModal();
      } else if (e.key === 'ArrowLeft') {
        navigateModal('prev');
      } else if (e.key === 'ArrowRight') {
        navigateModal('next');
      }
    };
    
    document.addEventListener('keydown', handleKeyPress);
    return () => document.removeEventListener('keydown', handleKeyPress);
  }, [isModalOpen, currentRegionIndex]);

  const nowPlaying = (TOUR.regions||[]).find((r:any)=> r.id===activeRegionId);

  return (
    <div className="min-h-screen w-full bg-gradient-to-br from-neutral-950 via-neutral-900 to-neutral-950 text-neutral-100">
      {/* Header */}
      <div className="mx-auto max-w-7xl px-6 py-6 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg" />
          <div>
            <div className="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">{TOUR.title}</div>
            <div className="text-sm text-neutral-400">GPS‚Äëtriggered audio walk {preview ? '¬∑ Preview CMS' : ''}</div>
          </div>
        </div>
        <div className="flex items-center gap-3">
          <button 
            className="rounded-xl bg-neutral-800/50 hover:bg-neutral-700/50 px-4 py-2 text-sm transition-all duration-200 hover:scale-105" 
            onClick={()=>{ try{ window.open('/cms','_self'); }catch{ window.location.hash='#cms'; } }}
          >
            <span className="flex items-center gap-2">
              <span className="w-2 h-2 rounded-full bg-blue-400"></span>
              Apri CMS
            </span>
          </button>
          <select 
            className="rounded-xl bg-neutral-800/50 border border-neutral-700/50 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all duration-200" 
            value={selectedTourIndex}
            onChange={(e)=> setSelectedTourIndex(parseInt(e.target.value))}
          >
            {availableTours.map((tour, index) => (
              <option key={index} value={index}>{tour.title}</option>
            ))}
          </select>
          <select 
            className="rounded-xl bg-neutral-800/50 border border-neutral-700/50 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all duration-200" 
            value={locale} 
            onChange={(e)=> {
              const newLocale = e.target.value;
              setLocale(newLocale);
              
              // If this is a CMS tour with available languages, switch to the correct tour
              if (TOUR.availableLanguages) {
                const targetLanguage = TOUR.availableLanguages.find((lang: any) => lang.code === newLocale);
                if (targetLanguage) {
                  // Find the tour with this language
                  const targetTourIndex = availableTours.findIndex((tour: any) => 
                    tour.availableLanguages?.some((lang: any) => lang.tourId === targetLanguage.tourId)
                  );
                  if (targetTourIndex !== -1) {
                    setSelectedTourIndex(targetTourIndex);
                  }
                }
              }
            }}
          >
            {TOUR.availableLanguages ? 
              TOUR.availableLanguages.map((lang: any) => (
                <option key={lang.code} value={lang.code}>
                  {lang.code.split('-')[0].toUpperCase()}
                </option>
              )) : 
              (TOUR.locales||[]).map((l:string)=> (
                <option key={l} value={l}>{l}</option>
              ))
            }
          </select>
          <button 
            className={`rounded-xl px-4 py-2 text-sm font-medium transition-all duration-200 hover:scale-105 shadow-lg ${
              usingGPS 
                ? 'bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500' 
                : 'bg-neutral-800/50 hover:bg-neutral-700/50'
            }`} 
            onClick={()=> setUsingGPS((v)=> !v)}
          >
            <span className="flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${usingGPS ? 'bg-emerald-400 animate-pulse' : 'bg-neutral-400'}`}></span>
              {usingGPS ? 'GPS Attivo' : 'GPS Off'}
            </span>
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="mx-auto max-w-7xl px-6 pb-8">
          {/* Map */}
          <div className="w-full">
            <PlayerMap 
              tour={TOUR}
              userPos={userPos}
              activeRegionId={activeRegionId}
              jumpToRegion={jumpToRegion}
              setUserPos={setUserPos}
              openModal={openModal}
            />
          </div>

          {/* Action Buttons */}
          <div className="flex justify-center gap-4 mt-6">
            <button
              onClick={openInfoModal}
              className="px-8 py-4 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 border border-blue-500/50 text-white font-bold transition-all duration-200 hover:scale-105 shadow-lg"
            >
              üìã Info
            </button>
            <button
              onClick={startTour}
              className="px-8 py-4 rounded-xl bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 border border-emerald-500/50 text-white font-bold transition-all duration-200 hover:scale-105 shadow-lg"
            >
              üöÄ Inizia
            </button>
          </div>
        </div>
      </div>

      {/* Region Modal */}
      {isModalOpen && modalRegion && (
                    <img 
                      src={TOUR.tourImageDataUrl} 
                      alt="Tour" 
                      className="w-full h-48 object-cover rounded-lg border border-blue-500/30 shadow-lg" 
                    />
                    <div className="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded-full">
                      üèõÔ∏è
                    </div>
                  </div>
                </div>
              )}

              {/* Tour Description */}
              {TOUR.description && (
                <div className="bg-gradient-to-r from-emerald-600/10 to-teal-600/10 border border-emerald-500/30 rounded-xl p-4">
                  <div className="text-xs text-emerald-400 mb-2 font-bold uppercase tracking-wide">üìñ Descrizione Tour</div>
                  <div className="text-sm text-neutral-100 leading-relaxed">
                    {TOUR.description}
                  </div>
                </div>
              )}

              {/* Tour Stats */}
              <div className="bg-gradient-to-r from-purple-600/10 to-pink-600/10 border border-purple-500/30 rounded-xl p-4">
                <div className="text-xs text-purple-400 mb-2 font-bold uppercase tracking-wide">üìä Statistiche</div>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <div className="text-neutral-400">Regioni</div>
                    <div className="text-neutral-200 font-bold">{(TOUR.regions || []).length}</div>
                  </div>
                  <div>
                    <div className="text-neutral-400">Lingue</div>
                    <div className="text-neutral-200 font-bold">
                      {TOUR.availableLanguages ? TOUR.availableLanguages.length : 1}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Now Playing */}
          <div className="rounded-2xl border border-neutral-800/50 bg-neutral-900/30 backdrop-blur-sm p-6 shadow-xl">
            <div className="text-sm text-neutral-400 mb-4 font-medium">In riproduzione</div>
            {nowPlaying ? (
              <div className="space-y-4">
                {/* Header with enhanced styling */}
                <div className="bg-gradient-to-r from-indigo-600/20 to-purple-600/20 border border-indigo-500/30 rounded-xl p-4">
                  <div className="text-xl font-bold text-indigo-200 mb-1">{nowPlaying.name || `Punto ${nowPlaying.sort}`}</div>
                  <div className="text-xs text-indigo-400">Regione #{nowPlaying.sort} ‚Ä¢ Raggio {nowPlaying.radiusM}m</div>
                </div>
                
                {/* Description with enhanced styling */}
                {nowPlaying.description && (
                  <div className="bg-gradient-to-r from-emerald-600/10 to-teal-600/10 border border-emerald-500/30 rounded-xl p-4">
                    <div className="text-xs text-emerald-400 mb-2 font-bold uppercase tracking-wide">üìù Descrizione</div>
                    <div className="text-sm text-neutral-100 leading-relaxed">
                      {nowPlaying.description}
                    </div>
                  </div>
                )}

                {/* Reference Image with enhanced styling */}
                {nowPlaying.imageDataUrl && (
                  <div className="bg-gradient-to-r from-blue-600/10 to-cyan-600/10 border border-blue-500/30 rounded-xl p-4">
                    <div className="text-xs text-blue-400 mb-3 font-bold uppercase tracking-wide">üñºÔ∏è Immagine di Riferimento</div>
                    <div className="relative">
                      <img 
                        src={nowPlaying.imageDataUrl} 
                        alt="Reference" 
                        className="w-full h-64 object-contain rounded-lg border border-blue-500/30 shadow-lg bg-neutral-900/50" 
                      />
                      <div className="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded-full">
                        üì∑
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Transcript with enhanced styling */}
                {nowPlaying.transcript && (
                  <div className="bg-gradient-to-r from-purple-600/10 to-pink-600/10 border border-purple-500/30 rounded-xl p-4">
                    <div className="text-xs text-purple-400 mb-2 font-bold uppercase tracking-wide">üìÑ Trascrizione</div>
                    <div className="text-sm text-neutral-100 leading-relaxed">
                      {nowPlaying.transcript}
                    </div>
                  </div>
                )}
                
                {/* Status badges with enhanced styling */}
                <div className="flex flex-wrap gap-2">
                  <span className="rounded-full bg-emerald-600/30 border border-emerald-500/50 px-3 py-1 text-xs text-emerald-200 font-bold shadow-lg">üéµ Auto‚Äëplay</span>
                  <span className="rounded-full bg-blue-600/30 border border-blue-500/50 px-3 py-1 text-xs text-blue-200 font-bold shadow-lg">üìç Geofence</span>
                  {isPlaying && (
                    <span className="rounded-full bg-purple-600/30 border border-purple-500/50 px-3 py-1 text-xs text-purple-200 font-bold shadow-lg animate-pulse">
                      üîä Playing Now
                    </span>
                  )}
                </div>
                
                {/* Subtitle display */}
                {currentSubtitle && (
                  <div className="bg-gradient-to-r from-yellow-600/10 to-orange-600/10 border border-yellow-500/30 rounded-xl p-4">
                    <div className="text-xs text-yellow-400 mb-2 font-bold uppercase tracking-wide">üìù Sottotitoli</div>
                    <div className="text-sm text-neutral-100 leading-relaxed font-medium">
                      {currentSubtitle.text}
                    </div>
                    <div className="text-xs text-neutral-400 mt-2">
                      {currentSubtitle.startTime} ‚Üí {currentSubtitle.endTime}
                    </div>
                  </div>
                )}
                
                {/* Stop button with enhanced styling */}
                {isPlaying && (
                  <button 
                    onClick={stopAudio}
                    className="w-full rounded-xl bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 border border-red-500/50 px-4 py-3 text-sm text-white font-bold transition-all duration-200 hover:scale-105 shadow-lg"
                  >
                    ‚èπÔ∏è Stop Audio
                  </button>
                )}
              </div>
            ) : (
              <div className="text-center py-8">
                <div className="text-4xl mb-2">üéµ</div>
                <div className="text-neutral-400 text-sm">Nessun brano in riproduzione</div>
                <div className="text-neutral-500 text-xs mt-1">Seleziona una regione per iniziare</div>
              </div>
            )}
          </div>

          {/* Regions List */}
          <div className="rounded-2xl border border-neutral-800/50 bg-neutral-900/30 backdrop-blur-sm p-6 shadow-xl">
            <div className="text-sm text-neutral-400 mb-4 font-medium">Regioni del tour</div>
            <div className="flex flex-col gap-3">
              {(TOUR.regions||[]).map((r: any) => (
                <button 
                  key={r.id} 
                  className={`flex w-full items-start justify-between rounded-xl p-4 text-left transition-all duration-300 hover:scale-105 ${
                    activeRegionId === r.id 
                      ? 'bg-gradient-to-r from-indigo-600/30 to-purple-600/30 border-2 border-indigo-400/50 shadow-2xl scale-105' 
                      : 'bg-neutral-800/30 hover:bg-neutral-700/30 border border-neutral-700/50 hover:border-neutral-600/50'
                  }`} 
                  onClick={() => jumpToRegion(r.id)}
                >
                  <div className="flex-1">
                    <div className={`text-sm font-bold ${activeRegionId === r.id ? 'text-indigo-200' : 'text-neutral-100'}`}>
                      {r.name || `Punto ${r.sort}`}
                    </div>
                    <div className={`text-xs mt-1 ${activeRegionId === r.id ? 'text-indigo-400' : 'text-neutral-400'}`}>
                      Raggio {r.radiusM} m ¬∑ Ordine {r.sort}
                    </div>
                    {r.description && (
                      <div className={`text-xs mt-1 line-clamp-1 ${activeRegionId === r.id ? 'text-indigo-300' : 'text-neutral-500'}`}>
                        {r.description}
                      </div>
                    )}
                    {r.transcript && (
                      <div className={`text-xs mt-1 line-clamp-2 ${activeRegionId === r.id ? 'text-indigo-300' : 'text-neutral-500'}`}>
                        {r.transcript}
                      </div>
                    )}
                  </div>
                  <div className="flex flex-col items-end gap-2 ml-2">
                    {r.imageDataUrl && (
                      <div className={`relative ${activeRegionId === r.id ? 'ring-2 ring-indigo-400/50' : ''}`}>
                        <img 
                          src={r.imageDataUrl} 
                          alt="Preview" 
                          className="w-12 h-12 object-cover rounded-lg border border-neutral-600/50" 
                        />
                        {activeRegionId === r.id && (
                          <div className="absolute -top-1 -right-1 bg-indigo-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                            ‚ñ∂
                          </div>
                        )}
                      </div>
                    )}
                    <div className={`text-xs ${activeRegionId === r.id ? 'text-indigo-300 font-bold' : 'text-neutral-300'}`}>
                      {activeRegionId === r.id ? 'üéµ In riproduzione' : 'Tap per simulare'}
                    </div>
                  </div>
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* Region Modal */}
      {isModalOpen && modalRegion && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 backdrop-blur-sm">
          <div className="relative w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-700 rounded-2xl shadow-2xl mx-4">
            {/* Modal Header */}
            <div className="flex items-center justify-between p-6 border-b border-neutral-700">
              <div className="flex items-center gap-4">
                <button
                  onClick={() => navigateModal('prev')}
                  className="p-2 rounded-xl bg-neutral-800/50 hover:bg-neutral-700/50 transition-all duration-200 hover:scale-105"
                  title="Previous region (‚Üê)"
                >
                  ‚Üê
                </button>
                <div>
                  <h2 className="text-xl font-bold text-neutral-100">
                    {modalRegion.name || `Punto ${modalRegion.sort}`}
                  </h2>
                  <div className="text-sm text-neutral-400">
                    {currentRegionIndex + 1} di {(TOUR.regions || []).length}
                  </div>
                </div>
                <button
                  onClick={() => navigateModal('next')}
                  className="p-2 rounded-xl bg-neutral-800/50 hover:bg-neutral-700/50 transition-all duration-200 hover:scale-105"
                  title="Next region (‚Üí)"
                >
                  ‚Üí
                </button>
              </div>
              <button
                onClick={closeModal}
                className="p-2 rounded-xl bg-neutral-800/50 hover:bg-neutral-700/50 transition-all duration-200 hover:scale-105"
                title="Close (Esc)"
              >
                ‚úï
              </button>
            </div>

            {/* Modal Content */}
            <div className="p-6 space-y-6">
              {/* Description */}
              {modalRegion.description && (
                <div>
                  <div className="text-sm text-neutral-100 leading-relaxed">
                    {modalRegion.description}
                  </div>
                </div>
              )}

              {/* Transcript */}
              {modalRegion.transcript && (
                <div>
                  <div className="text-sm text-neutral-100 leading-relaxed">
                    {modalRegion.transcript}
                  </div>
                </div>
              )}

              {/* Subtitles */}
              {currentSubtitle && (
                <div className="bg-gradient-to-r from-yellow-600/10 to-orange-600/10 border border-yellow-500/30 rounded-xl p-4">
                  <div className="text-sm text-neutral-100 leading-relaxed font-medium text-center">
                    {currentSubtitle.text}
                  </div>
                </div>
              )}

              {/* Image */}
              {modalRegion.imageDataUrl && (
                <div className="relative">
                  <img 
                    src={modalRegion.imageDataUrl} 
                    alt={modalRegion.name || `Region ${modalRegion.sort}`}
                    className="w-full h-64 object-contain rounded-lg border border-neutral-700 bg-neutral-900/50" 
                  />
                </div>
              )}

              {/* Audio Player Controls */}
              {isPlaying && (
                <div className="bg-gradient-to-r from-purple-600/10 to-pink-600/10 border border-purple-500/30 rounded-xl p-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-purple-200 font-medium">üéµ Playing</span>
                    <button 
                      onClick={stopAudio}
                      className="px-4 py-2 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-500/30 text-red-200 text-sm transition-all duration-200"
                    >
                      ‚èπÔ∏è Stop
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
